# .github/workflows/management.yml
name: ğŸš€ Ultimate VPN System Management V2

on:
  # Ø§Ø¬Ø§Ø²Ù‡ Ø§Ø¬Ø±Ø§ÛŒ Ø¯Ø³ØªÛŒ Ø§Ø² Ù¾Ù†Ù„ Ú¯ÛŒØªâ€ŒÙ‡Ø§Ø¨ Ø§Ú©Ø´Ù†Ø² Ø¨Ø±Ø§ÛŒ ÙˆØ¸Ø§ÛŒÙ Ø§Ø¯Ù…ÛŒÙ†
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
        - generate_new_config
        - scan_and_update_default_ip
        - manually_update_regional_ip

      # ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ 'generate_new_config'
      user_id:
        description: 'User ID for the new config (e.g., my-friend-01)'
        required: false
      duration_days:
        description: 'Subscription duration in days'
        required: false
        default: '30'
      region:
        description: 'IP Region for the config'
        required: false
        type: choice
        options:
        - default
        - de # Germany
        - ir # Iran (if you have a specific IP for it)
        default: 'default'
      block_porn:
        description: 'Block adult content via DNS?'
        required: false
        type: boolean
        default: false

      # ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ 'manually_update_regional_ip'
      target_region:
        description: 'The region to update (e.g., de, ir, default)'
        required: false
      ip_address:
        description: 'The new clean IP:Port (e.g., 162.159.192.1:2408)'
        required: false

  # Ø§Ø¬Ø±Ø§ÛŒ Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø§Ø³Ú©Ù† Ø®ÙˆØ¯Ú©Ø§Ø± IP
  schedule:
    # Ù‡Ø± Û´ Ø³Ø§Ø¹Øª ÛŒÚ©Ø¨Ø§Ø± Ø¨Ø±Ø§ÛŒ Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø¨Ù‡ØªØ±ÛŒÙ† IP Ø¹Ù…ÙˆÙ…ÛŒ Ø§Ø¬Ø±Ø§ Ù…ÛŒâ€ŒØ´ÙˆØ¯
    - cron: '0 */4 * * *'

jobs:
  # ==========================================================
  # == JOB 1: Ø³Ø§Ø®Øª Ú©Ø§Ù†ÙÛŒÚ¯ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±
  # ==========================================================
  generate_config:
    name: "âœ… Generate New VPN Config"
    # ÙÙ‚Ø· Ø²Ù…Ø§Ù†ÛŒ Ø§Ø¬Ø±Ø§ Ø´Ùˆ Ú©Ù‡ Ø§Ú©Ø´Ù† 'generate_new_config' Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡ Ùˆ user_id Ø®Ø§Ù„ÛŒ Ù†Ø¨Ø§Ø´Ø¯
    if: github.event.inputs.action == 'generate_new_config' && github.event.inputs.user_id != ''
    runs-on: ubuntu-latest
    steps:
      - name: "Sending request to Cloudflare Worker to generate config"
        run: |
          echo "Generating config for user: ${{ github.event.inputs.user_id }}"
          # Ø§Ø² -sS Ø¨Ø±Ø§ÛŒ Ø­Ø§Ù„Øª Ø³Ú©ÙˆØª Ø¯Ø± Ù…ÙˆÙÙ‚ÛŒØª Ùˆ Ù†Ù…Ø§ÛŒØ´ Ø®Ø·Ø§ Ø¯Ø± Ø´Ú©Ø³Øª Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯
          # -w Ø¨Ø±Ø§ÛŒ Ø¬Ø¯Ø§ Ú©Ø±Ø¯Ù† Ø¨Ø¯Ù†Ù‡ Ù¾Ø§Ø³Ø® Ø§Ø² Ú©Ø¯ ÙˆØ¶Ø¹ÛŒØª HTTP Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯
          response=$(curl -sS -w "\nHTTP_STATUS:%{http_code}" \
            -X POST "${{ secrets.WORKER_URL }}/api/admin/generate" \
            -H "Authorization: Bearer ${{ secrets.ADMIN_KEY }}" \
            -H "Content-Type: application/json" \
            --data '{
              "userId": "${{ github.event.inputs.user_id }}",
              "durationDays": ${{ github.event.inputs.duration_days }},
              "region": "${{ github.event.inputs.region }}",
              "blockPorn": ${{ github.event.inputs.block_porn }}
            }')
          
          # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ú©Ø¯ ÙˆØ¶Ø¹ÛŒØª Ùˆ Ø¨Ø¯Ù†Ù‡ Ù¾Ø§Ø³Ø®
          http_status=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')

          echo "Response Body: $body"
          echo "Status Line: $http_status"

          if [[ $(echo "$http_status" | grep "HTTP_STATUS:200") ]]; then
            echo "âœ… Config generated successfully! Check the output above for the subscription URL."
          else
            echo "âŒ ERROR: Failed to generate config. Server response above."
            exit 1
          fi

  # ==========================================================
  # == JOB 2: Ø§Ø³Ú©Ù† Ùˆ Ø¢Ù¾Ø¯ÛŒØª Ø®ÙˆØ¯Ú©Ø§Ø± IP Ù¾ÛŒØ´â€ŒÙØ±Ø¶
  # ==========================================================
  scan_and_update_default_ip:
    name: "ğŸ›°ï¸ Scan & Update Default WARP IP"
    # Ø²Ù…Ø§Ù†ÛŒ Ø§Ø¬Ø±Ø§ Ø´Ùˆ Ú©Ù‡ Ø¨Ù‡ ØµÙˆØ±Øª Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ Ø´Ø¯Ù‡ ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Ø´ÙˆØ¯ ÛŒØ§ Ø¨Ù‡ ØµÙˆØ±Øª Ø¯Ø³ØªÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ø´ÙˆØ¯
    if: github.event_name == 'schedule' || github.event.inputs.action == 'scan_and_update_default_ip'
    runs-on: ubuntu-latest
    steps:
      - name: "Checkout WarpScanner repository"
        uses: actions/checkout@v4
        with:
          repository: 'ircfspace/warpscan'
          path: 'warpscan'

      - name: "Running WARP Scanner for the best IP"
        id: scanner
        run: |
          cd warpscan
          # Ø§Ø³Ú©Ù† Ø¨Ø§ Û±Û° ØªØ±Ø¯ Ù…ÙˆØ§Ø²ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÙØ²Ø§ÛŒØ´ Ø³Ø±Ø¹Øª
          bash warpscan.sh -p10
          # Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø¨Ù‡ØªØ±ÛŒÙ† IP Ø±Ø§ Ø¯Ø± result.csv Ù…ÛŒâ€ŒÙ†ÙˆÛŒØ³Ø¯. Ù…Ø§ Ø®Ø· Ø§ÙˆÙ„ Ø±Ø§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù†ÛŒÙ…
          BEST_IP=$(head -n 1 result.csv | awk -F, '{print $1":"$2}')
          if [[ -z "$BEST_IP" ]]; then
            echo "::error::Scanner failed to find a valid IP."
            exit 1
          fi
          echo "Scanner finished. Best IP found: $BEST_IP"
          echo "best_ip=$BEST_IP" >> $GITHUB_OUTPUT

      - name: "Updating Default IP in Cloudflare Worker"
        if: steps.scanner.outputs.best_ip
        run: |
          echo "Sending best IP (${{ steps.scanner.outputs.best_ip }}) to Cloudflare..."
          curl -sS -f -X POST "${{ secrets.WORKER_URL }}/api/admin/update-ip" \
            -H "Authorization: Bearer ${{ secrets.ADMIN_KEY }}" \
            -H "Content-Type: application/json" \
            --data '{"ip": "${{ steps.scanner.outputs.best_ip }}", "region": "default"}'
          echo "âœ… Default IP Updated Successfully!"

  # ==========================================================
  # == JOB 3: ØªÙ†Ø¸ÛŒÙ… Ø¯Ø³ØªÛŒ IP Ø¨Ø±Ø§ÛŒ ÛŒÚ© Ø±ÛŒØ¬Ù† Ø®Ø§Øµ
  # ==========================================================
  update_regional_ip:
    name: "âœï¸ Manually Update Regional IP"
    if: github.event.inputs.action == 'manually_update_regional_ip' && github.event.inputs.target_region != '' && github.event.inputs.ip_address != ''
    runs-on: ubuntu-latest
    steps:
      - name: "Updating regional IP in Cloudflare Worker"
        run: |
          echo "Setting IP for region '${{ github.event.inputs.target_region }}' to '${{ github.event.inputs.ip_address }}'"
          curl -sS -f -X POST "${{ secrets.WORKER_URL }}/api/admin/update-ip" \
            -H "Authorization: Bearer ${{ secrets.ADMIN_KEY }}" \
            -H "Content-Type: application/json" \
            --data '{"ip": "${{ github.event.inputs.ip_address }}", "region": "${{ github.event.inputs.target_region }}"}'
          echo "âœ… Regional IP for '${{ github.event.inputs.target_region }}' updated successfully!"

